<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ»ã‚µãƒ¼ãƒä¸è¦ / IndexedDBç‰ˆï¼‰</title>
  <style>
    :root{ --bg:#0b1220; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --blue:#3b82f6; --amber:#f59e0b; --violet:#8b5cf6; --danger:#ef4444; --slate:#64748b; --radius:14px; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,var(--bg),#0f172a);color:var(--text)}
    .app{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:rgba(7,14,24,.7);backdrop-filter:blur(6px);padding:12px;border-bottom:1px solid rgba(148,163,184,.06);display:flex;align-items:center;gap:12px;z-index:2}
    .title{font-weight:700;font-size:18px}
    #backBtn{margin-left:6px}
    .panel{background:rgba(17,24,39,.75);border-radius:var(--radius);padding:14px;border:1px solid rgba(148,163,184,.06);box-shadow:0 6px 18px rgba(2,6,23,.5)}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;background:#07101b;border:1px solid rgba(148,163,184,.06);color:var(--text);box-sizing:border-box}
    button{border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-amber{background:var(--amber);color:#000}
    .btn-green{background:var(--accent);color:#072a12}
    .btn-violet{background:var(--violet);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-slate{background:var(--slate);color:#fff}
    .btn-outline{background:transparent;color:var(--text);border:1px solid rgba(148,163,184,.08)}
    .listgrid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:12px}
    @media (max-width:1024px){.listgrid{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:640px){.listgrid{grid-template-columns:repeat(4,1fr)}}
    .listcard{grid-column:span 4;background:linear-gradient(180deg,#0c1622,#0f1a2a);padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:8px}
    .listcard h4{margin:0;font-size:16px}
    .meta{font-size:12px;color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .stack{display:flex;flex-direction:column;gap:12px}
    .thumb{width:52px;height:52px;border-radius:8px;object-fit:cover;border:1px solid rgba(148,163,184,.06);cursor:pointer}
    .empty{text-align:center;padding:36px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(148,163,184,.06);vertical-align:middle}

    /* modal */
    .modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.86);align-items:center;justify-content:center}
    .modal img{max-width:92%;max-height:92%;border-radius:10px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <button id="backBtn" class="btn btn-slate" style="display:none">ğŸ  ãƒªã‚¹ãƒˆä¸€è¦§ã¸</button>
      <div class="title">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</div>
    </header>

    <main id="view" style="margin-top:12px"></main>
  </div>

  <div id="imgModal" class="modal"><img id="imgModalImg" src="" alt=""/></div>

  <!-- JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã®éš ã—inputï¼ˆãƒªã‚¹ãƒˆå˜ä½ï¼‰ -->
  <input type="file" id="importJsonInput" accept="application/json,.json" style="display:none" />

  <script>
  (function(){
    // ==== Utilities (JSTå¯¾å¿œ) ====
    const $ = (s, r=document)=> r.querySelector(s);
    const create = (tag, attrs={})=>{ const e = document.createElement(tag); for(const k in attrs) e.setAttribute(k, attrs[k]); return e; };
    const pad2 = n=> String(n).padStart(2,'0');
    const jstDateObj = (d=new Date())=>{ // Dateã‚’JSTã®åŒä¸€æ™‚åˆ»è¡¨ç¤ºã«åˆã‚ã›ãŸDate(ãƒ­ãƒ¼ã‚«ãƒ«)ã¸
      const s = d.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' });
      return new Date(s);
    };
    const jstISO = (d=new Date())=>{ const x=jstDateObj(d); return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`; };
    const jstTodayISO = ()=> jstISO(new Date());
    const jstTime = ()=>{ const x=jstDateObj(new Date()); return `${pad2(x.getHours())}:${pad2(x.getMinutes())}`; };
    const fmt = (iso)=> iso? iso.replace(/-/g,'/') : '';
    const uuid = ()=> (crypto && crypto.randomUUID)? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{ const r=Math.random()*16|0; const v=c==='x'?r:(r&0x3|0x8); return v.toString(16); });

    async function fileToDataURLCompressed(file, maxSide=1280, quality=0.85){
      const dataURL = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onerror=rej; fr.onload=()=>res(fr.result); fr.readAsDataURL(file); });
      const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL; });
      const scale = Math.min(1, maxSide/Math.max(img.width,img.height));
      const cw = Math.max(1, Math.round(img.width*scale));
      const ch = Math.max(1, Math.round(img.height*scale));
      const canvas = document.createElement('canvas'); canvas.width=cw; canvas.height=ch; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
      return canvas.toDataURL('image/jpeg', quality);
    }

    const SCHEDULE_OFFSETS = [0,1,3,7,14,30,90];

    // ==== IndexedDBï¼ˆBlobå¯¾å¿œï¼‰ ====
    const KEY_LOCALSTORAGE = 'flashcards_local_v4'; // æ—§ç‰ˆã‚­ãƒ¼ï¼ˆè‡ªå‹•ç§»è¡Œç”¨ï¼‰
    const IDB_NAME = 'flashcards_idb_v1';
    const IDB_VER = 1;
    let idb;

    function openIDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(IDB_NAME, IDB_VER);
        req.onupgradeneeded = (e)=>{
          const db = e.target.result;
          if(!db.objectStoreNames.contains('kv')){
            db.createObjectStore('kv', { keyPath:'key' }); // {key:'db', value: <json>}
          }
          if(!db.objectStoreNames.contains('blobs')){
            db.createObjectStore('blobs', { keyPath:'key' }); // {key:'img:...',{blob}}
          }
        };
        req.onsuccess = ()=>{ idb = req.result; resolve(idb); };
        req.onerror = ()=> reject(req.error);
      });
    }
    function idbGet(store, key){
      return new Promise((res,rej)=>{
        const tx = idb.transaction(store,'readonly');
        const st = tx.objectStore(store);
        const r = st.get(key);
        r.onsuccess = ()=> res(r.result);
        r.onerror = ()=> rej(r.error);
      });
    }
    function idbPut(store, val){
      return new Promise((res,rej)=>{
        const tx = idb.transaction(store,'readwrite');
        const st = tx.objectStore(store);
        const r = st.put(val);
        r.onsuccess = ()=> res();
        r.onerror = ()=> rej(r.error);
      });
    }
    function idbDel(store, key){
      return new Promise((res,rej)=>{
        const tx = idb.transaction(store,'readwrite');
        const st = tx.objectStore(store);
        const r = st.delete(key);
        r.onsuccess = ()=> res();
        r.onerror = ()=> rej(r.error);
      });
    }

    function dataURLtoBlob(dataURL){
      const m = dataURL.match(/^data:(.*?);base64,(.*)$/);
      if(!m) return null;
      const mime = m[1]; const b64 = m[2];
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], {type:mime});
    }

    async function storeImageIfNeeded(card, which){ // which: 'q' | 'a'
      const prop = which==='q' ? 'qImg' : 'aImg';
      const refProp = which==='q' ? 'qImgRef' : 'aImgRef';
      const val = card[prop];
      if(!val){ 
        if(card[refProp]){ try{ await idbDel('blobs', card[refProp]); }catch{} }
        card[refProp] = null;
        return;
      }
      if(typeof val === 'string' && val.startsWith('data:')){
        const blob = dataURLtoBlob(val);
        const key = `img:${uuid()}`;
        await idbPut('blobs', {key, blob});
        if(card[refProp] && card[refProp]!==key){ try{ await idbDel('blobs', card[refProp]); }catch{} }
        card[refProp] = key;
        return;
      }
    }

    async function loadImageURLFromRef(ref){
      if(!ref) return '';
      const rec = await idbGet('blobs', ref);
      if(!rec || !rec.blob) return '';
      return URL.createObjectURL(rec.blob);
    }

    // ==== ã‚¢ãƒ—ãƒªã® in-memory DB ====
    let DB = {lists:[],cards:[]};

    async function persistToIDB(){
      for(const c of DB.cards){
        await storeImageIfNeeded(c, 'q');
        await storeImageIfNeeded(c, 'a');
      }
      const saveObj = {
        lists: DB.lists.map(x=>({id:x.id,name:x.name,createdAt:x.createdAt})),
        cards: DB.cards.map(c=>({
          id:c.id, listId:c.listId, createdAt:c.createdAt,
          qText:c.qText||'', aText:c.aText||'',
          qImgRef:c.qImgRef||null, aImgRef:c.aImgRef||null,
          attempts: (c.attempts||[]).map(a=>({date:a.date,time:a.time,correct:!!a.correct})),
          manualNextDue: c.manualNextDue || null
        }))
      };
      await idbPut('kv', {key:'db', value:saveObj});
    }
    function save(){ persistToIDB().catch(console.error); }

    async function loadFromIDBOrMigrate(){
      const rec = await idbGet('kv','db');
      if(rec && rec.value){
        const raw = rec.value;
        const lists = raw.lists||[];
        const cards = raw.cards||[];
        const runtimeCards = [];
        for(const c of cards){
          const qURL = c.qImgRef ? (await loadImageURLFromRef(c.qImgRef)) : '';
          const aURL = c.aImgRef ? (await loadImageURLFromRef(c.aImgRef)) : '';
          runtimeCards.push({
            id:c.id, listId:c.listId, createdAt:c.createdAt,
            qText:c.qText||'', aText:c.aText||'',
            qImg:qURL, aImg:aURL,
            qImgRef:c.qImgRef||null, aImgRef:c.aImgRef||null,
            attempts:c.attempts||[], manualNextDue:c.manualNextDue||null
          });
        }
        DB = {lists, cards: runtimeCards};
        return;
      }
      // migrate from localStorage (æ—§ç‰ˆ)
      try{
        const rawLS = localStorage.getItem(KEY_LOCALSTORAGE);
        if(rawLS){
          const src = JSON.parse(rawLS);
          src.lists ||= []; src.cards ||= [];
          for(const c of src.cards){
            if(c.qImg){ const b = dataURLtoBlob(c.qImg); const k = `img:${uuid()}`; await idbPut('blobs',{key:k, blob:b}); c.qImgRef = k; }
            if(c.aImg){ const b = dataURLtoBlob(c.aImg); const k = `img:${uuid()}`; await idbPut('blobs',{key:k, blob:b}); c.aImgRef = k; }
          }
          await idbPut('kv', {key:'db', value:{
            lists: src.lists.map(x=>({id:x.id,name:x.name,createdAt:x.createdAt})),
            cards: src.cards.map(c=>({
              id:c.id, listId:c.listId, createdAt:c.createdAt,
              qText:c.qText||'', aText:c.aText||'',
              qImgRef:c.qImgRef||null, aImgRef:c.aImgRef||null,
              attempts:c.attempts||[], manualNextDue:c.manualNextDue||null
            }))
          }});
          await loadFromIDBOrMigrate();
          return;
        }
      }catch(e){ console.warn('migration failed', e); }
      DB = {lists:[], cards:[]};
    }

    // ==== schedule helpers ====
    function nextDueDate(card){
      const n = card.attempts?.length || 0;
      if(n >= 7) return null; // finished
      if(card.manualNextDue) return card.manualNextDue;
      if(n === 0) return card.createdAt;
      const lastDate = (card.attempts[n-1].date);
      const offset = SCHEDULE_OFFSETS[n];
      const [y,m,d] = lastDate.split('-').map(Number);
      const base = new Date(Date.UTC(y, m-1, d));
      base.setUTCDate(base.getUTCDate()+offset);
      const y2 = base.getUTCFullYear(); const m2 = pad2(base.getUTCMonth()+1); const d2 = pad2(base.getUTCDate());
      return `${y2}-${m2}-${d2}`;
    }
    const isDueTodayOrPast = (card)=>{ const nd = nextDueDate(card); return nd && nd <= jstTodayISO(); };

    // ==== models ====
    function createList(name){ const id = uuid(); DB.lists.push({id,name,createdAt:jstTodayISO()}); save(); return id; }
    function deleteList(id){
      const related = DB.cards.filter(c=>c.listId===id);
      Promise.all(related.map(async c=>{
        if(c.qImgRef) await idbDel('blobs', c.qImgRef).catch(()=>{});
        if(c.aImgRef) await idbDel('blobs', c.aImgRef).catch(()=>{});
      })).finally(()=>{});
      DB.lists = DB.lists.filter(l=>l.id!==id);
      DB.cards = DB.cards.filter(c=>c.listId!==id);
      save();
    }
    function createCard(listId, {qText,qImg,aText,aImg}){
      const id = uuid();
      DB.cards.push({id,listId,createdAt:jstTodayISO(),qText:qText||'',qImg:qImg||'',aText:aText||'',aImg:aImg||'',attempts:[],manualNextDue:null,qImgRef:null,aImgRef:null});
      save();
      return id;
    }
    function updateCard(id, patch){
      const c = DB.cards.find(x=>x.id===id); if(!c) return;
      Object.assign(c, patch);
      save();
    }
    function deleteCard(id){
      const c = DB.cards.find(x=>x.id===id);
      if(c){
        if(c.qImgRef) idbDel('blobs', c.qImgRef).catch(()=>{});
        if(c.aImgRef) idbDel('blobs', c.aImgRef).catch(()=>{});
      }
      DB.cards = DB.cards.filter(x=>x.id!==id);
      save();
    }
    const listCards = (listId)=> DB.cards.filter(x=>x.listId===listId);

    // ==== UI render ====
    const stack = [];
    function go(screen, params={}){ stack.push({screen, params}); render(); }
    function goHome(){ stack.length = 0; stack.push({screen:'home',params:{}}); render(); }

    function render(){
      const view = $('#view');
      const top = stack[stack.length-1] || {screen:'home',params:{}};
      $('#backBtn').style.display = top.screen !== 'home' ? 'inline-flex' : 'none';
      $('#backBtn').onclick = ()=> goHome();

      switch(top.screen){
        case 'home': return renderHome(view);
        case 'listMenu': return renderListMenu(view, top.params);
        case 'register': return renderRegister(view, top.params);
        case 'quiz': return renderQuiz(view, top.params);
        case 'problems': return renderProblems(view, top.params);
        case 'edit': return renderEdit(view, top.params);
        default: return renderHome(view);
      }
    }

    function renderHome(view){
      setTitle('ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ â€” ãƒªã‚¹ãƒˆ');
      view.innerHTML = '';
      const wrap = create('div'); wrap.className = 'stack';

      const form = create('div'); form.className = 'panel'; form.style.padding='12px';
      form.innerHTML = `
        <h3 style="margin:0 0 8px 0">ãƒªã‚¹ãƒˆä½œæˆ</h3>
        <label style="color:var(--muted);font-size:13px">ãƒªã‚¹ãƒˆå</label>
        <input id="newListName" placeholder="ä¾‹ï¼šè‹±å˜èªã€æ­´å²ã€è³‡æ ¼â€¦" />
        <div style="margin-top:10px;display:flex;gap:8px"><button id="createListBtn" class="btn btn-green">ï¼‹ ä½œæˆ</button></div>
        <div id="capacityLine" style="margin-top:8px;color:var(--muted);font-size:13px">å®¹é‡ç¢ºèªä¸­â€¦</div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">å…¨ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆIndexedDB/Blobï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚JSTåŸºæº–ã§æ—¥ä»˜ä¿å­˜ã€‚</div>
      `;
      wrap.appendChild(form);

      const listsPanel = create('div'); listsPanel.className = 'panel'; listsPanel.style.marginTop='12px';
      listsPanel.innerHTML = `<h3 style="margin:0 0 8px 0">ãƒªã‚¹ãƒˆä¸€è¦§</h3>`;
      const grid = create('div'); grid.className='listgrid';

      if(DB.lists.length === 0){
        const e = create('div'); e.className='empty'; e.textContent='ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ã€Œãƒªã‚¹ãƒˆä½œæˆã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'; listsPanel.appendChild(e);
      }else{
        DB.lists.forEach(l=>{
          const total = listCards(l.id).length;
          const due = listCards(l.id).filter(isDueTodayOrPast).length;
          const card = create('div'); card.className='listcard';
          const h = create('h4'); h.textContent = l.name; card.appendChild(h);
          const m = create('div'); m.className='meta'; m.textContent = `ä½œæˆ ${fmt(l.createdAt)} ãƒ» ç™»éŒ² ${total} ä»¶ ãƒ» æœŸæ—¥åˆ°æ¥ ${due} ä»¶`; card.appendChild(m);
          const tb = create('div'); tb.className='toolbar';
          const add = create('button'); add.className='btn btn-blue'; add.textContent='âœï¸ å•é¡Œç™»éŒ²'; add.onclick = ()=> go('register',{listId:l.id}); tb.appendChild(add);
          const prob = create('button'); prob.className='btn btn-amber'; prob.textContent='ğŸ“‹ å•é¡Œä¸€è¦§'; prob.onclick = ()=> go('problems',{listId:l.id}); tb.appendChild(prob);
          const quiz = create('button'); quiz.className='btn btn-violet'; quiz.textContent='ğŸ“ å‡ºé¡Œé–‹å§‹'; quiz.onclick = ()=> go('quiz',{listId:l.id}); tb.appendChild(quiz);
          const exp = create('button'); exp.className='btn btn-outline'; exp.textContent='â¬‡ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ'; exp.onclick = ()=> exportListById(l.id); tb.appendChild(exp);
          const imp = create('button'); imp.className='btn btn-outline'; imp.textContent='â¬†ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ'; imp.onclick = ()=> importFromJson(); tb.appendChild(imp);
          const del = create('button'); del.className='btn btn-danger'; del.textContent='ğŸ—‘ å‰Šé™¤'; del.onclick = ()=>{ if(confirm(`ã€Œ${l.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¸­ã®å•é¡Œã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)){ deleteList(l.id); render(); } }; tb.appendChild(del);
          card.appendChild(tb); grid.appendChild(card);
        });
        listsPanel.appendChild(grid);
      }
      wrap.appendChild(listsPanel);
      view.appendChild(wrap);

      $('#createListBtn').onclick = ()=>{
        const name = $('#newListName').value.trim();
        if(!name){ alert('ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(DB.lists.some(x=>x.name===name)){ alert('åŒåã®ãƒªã‚¹ãƒˆãŒæ—¢ã«ã‚ã‚Šã¾ã™'); return; }
        const id = createList(name);
        $('#newListName').value='';
        go('listMenu',{listId:id});
      };

      // å®¹é‡è¡¨ç¤ºã‚’æ›´æ–°
      updateCapacityLine();
    }

    function renderListMenu(view,{listId}){
      const list = DB.lists.find(x=>x.id===listId);
      if(!list){ goHome(); return; }
      setTitle(`ãƒªã‚¹ãƒˆï¼š${list.name}`);
      view.innerHTML = '';
      const panel = create('div'); panel.className='panel'; panel.innerHTML = `
        <h3 style="margin:0 0 8px 0">${escapeHtml(list.name)}</h3>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="toAdd" class="btn btn-blue">âœï¸ å•é¡Œç™»éŒ²</button>
          <button id="toQuiz" class="btn btn-violet">ğŸ“ å‡ºé¡Œ</button>
          <button id="toList" class="btn btn-amber">ğŸ“‹ å•é¡Œä¸€è¦§</button>
        </div>
      `;
      view.appendChild(panel);
      $('#toAdd').onclick = ()=> go('register',{listId});
      $('#toQuiz').onclick = ()=> go('quiz',{listId});
      $('#toList').onclick = ()=> go('problems',{listId});
    }

    function renderRegister(view,{listId}){
      const list = DB.lists.find(x=>x.id===listId); if(!list){ goHome(); return; }
      setTitle(`å•é¡Œç™»éŒ²ï¼ˆ${list.name}ï¼‰`);
      view.innerHTML = '';
      const form = create('form'); form.className='panel'; form.id='regForm';
      form.innerHTML = `
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label>å•é¡Œï¼ˆæ–‡ç« ï¼‰</label>
            <textarea id="qText" rows="4" placeholder="å•é¡Œæ–‡"></textarea>
          </div>
          <div style="width:260px">
            <label>å•é¡Œï¼ˆç”»åƒï¼‰</label>
            <input type="file" id="qImg" accept="image/*" />
            <img id="qPreview" class="thumb" style="display:none;margin-top:8px" />
          </div>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <div style="flex:1;min-width:220px">
            <label>å›ç­”ï¼ˆæ–‡ç« ï¼‰</label>
            <textarea id="aText" rows="4" placeholder="å›ç­”"></textarea>
          </div>
          <div style="width:260px">
            <label>å›ç­”ï¼ˆç”»åƒï¼‰</label>
            <input type="file" id="aImg" accept="image/*" />
            <img id="aPreview" class="thumb" style="display:none;margin-top:8px" />
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-green">ï¼‹ ç™»éŒ²ã™ã‚‹</button>
          <button type="button" class="btn btn-outline" id="clearBtn">ã‚¯ãƒªã‚¢</button>
          <button type="button" class="btn btn-amber" id="toListBtn">ğŸ“‹ å•é¡Œä¸€è¦§ã¸</button>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">æ–‡ç« ãƒ»ç”»åƒã¯ä¸¡æ–¹ã¨ã‚‚ç©ºã«ã§ãã¾ã›ã‚“ã€‚ç”»åƒã¯è‡ªå‹•åœ§ç¸®ä¿å­˜ï¼ˆJPG, IndexedDBã«Blobã¨ã—ã¦ä¿å­˜ï¼‰ã•ã‚Œã¾ã™ã€‚</div>
      `;
      view.appendChild(form);

      const qImg = $('#qImg', form); const aImg = $('#aImg', form);
      qImg.onchange = async ()=>{ const f=qImg.files[0]; if(!f) return; const url = await fileToDataURLCompressed(f); $('#qPreview', form).src = url; $('#qPreview', form).style.display='block'; }
      aImg.onchange = async ()=>{ const f=aImg.files[0]; if(!f) return; const url = await fileToDataURLCompressed(f); $('#aPreview', form).src = url; $('#aPreview', form).style.display='block'; }
      $('#clearBtn', form).onclick = ()=>{ $('#qText', form).value=''; $('#aText', form).value=''; $('#qPreview', form).style.display='none'; $('#aPreview', form).style.display='none'; qImg.value=''; aImg.value=''; }
      $('#toListBtn', form).onclick = ()=> go('problems',{listId});

      form.onsubmit = async (e)=>{
        e.preventDefault();
        const qText = $('#qText', form).value.trim();
        const aText = $('#aText', form).value.trim();
        let qImgData=''; let aImgData='';
        if(qImg.files[0]) qImgData = await fileToDataURLCompressed(qImg.files[0]);
        if(aImg.files[0]) aImgData = await fileToDataURLCompressed(aImg.files[0]);
        if(!qText && !qImgData){ alert('å•é¡Œã®æ–‡ç« ã¾ãŸã¯ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(!aText && !aImgData){ alert('å›ç­”ã®æ–‡ç« ã¾ãŸã¯ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        createCard(listId,{qText,qImg:qImgData,aText,aImg:aImgData});
        if(confirm('ç™»éŒ²ã—ã¾ã—ãŸã€‚ç¶šã‘ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')){
          $('#qText', form).value=''; $('#aText', form).value='';
          $('#qPreview', form).style.display='none'; $('#aPreview', form).style.display='none';
          qImg.value=''; aImg.value='';
        } else { go('listMenu',{listId}); }
      };
    }

    function renderQuiz(view,{listId}){
      const list = DB.lists.find(x=>x.id===listId); if(!list){ goHome(); return; }
      setTitle(`å‡ºé¡Œï¼ˆ${list.name}ï¼‰`);
      view.innerHTML = '';
      const due = listCards(listId).filter(c=> isDueTodayOrPast(c) && (c.attempts?.length || 0) < 7);
      if(due.length === 0){
        const p = create('div'); p.className='panel empty';
        p.innerHTML = `<div>æœ¬æ—¥å‡ºé¡Œã™ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div><div style="margin-top:10px"><button class='btn btn-slate' id='toHomeBtn'>ğŸ  ãƒªã‚¹ãƒˆä¸€è¦§ã¸</button></div>`;
        view.appendChild(p); $('#toHomeBtn').onclick = ()=> goHome(); return;
      }

      due.sort((a,b)=>{ const da = nextDueDate(a) || '9999-99-99'; const db = nextDueDate(b) || '9999-99-99'; if(da !== db) return da < db ? -1 : 1; return a.createdAt < b.createdAt ? -1 : 1; });

      let idx = 0;
      const wrap = create('div'); wrap.className='stack';
      const top = create('div'); top.className='panel';
      top.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div class='meta'>æ®‹ã‚Š <span id='remain'>${due.length}</span> å•</div><div class='meta'>æœ¬æ—¥ ${fmt(jstTodayISO())}</div></div><div></div></div>`;
      const qPanel = create('div'); qPanel.className='panel'; qPanel.style.marginTop='10px';
      qPanel.innerHTML = `<div id='qArea' class='quiz-q'></div><div id='qImgArea' style='margin-top:10px'></div><div style='margin-top:12px'><button id='revealBtn' class='btn btn-blue'>ç­”ãˆã‚’è¦‹ã‚‹</button></div><div id='answerBox' style='display:none;margin-top:12px'><div id='aArea' class='quiz-a'></div><div id='aImgArea' style='margin-top:8px'></div><div style='margin-top:12px;display:flex;gap:8px;flex-wrap:wrap'><button id='correctBtn' class='btn btn-green'>â—‹ æ­£è§£</button><button id='wrongBtn' class='btn btn-danger'>Ã— ä¸æ­£è§£</button></div></div>`;
      const histPanel = create('div'); histPanel.className='panel'; histPanel.style.marginTop='10px';
      histPanel.innerHTML = `<h4 style='margin:0 0 8px 0'>ã“ã®å•é¡Œã®å±¥æ­´</h4><div id='hist'></div>`;
      const donePanel = create('div'); donePanel.className='panel'; donePanel.style.display='none';
      donePanel.innerHTML = `<div class='empty'>æœ¬æ—¥ã®å‡ºé¡Œã¯å…¨ã¦çµ‚äº†ã—ã¾ã—ãŸã€‚<div style='margin-top:10px'><button id='toHome' class='btn btn-slate'>ğŸ  ãƒªã‚¹ãƒˆä¸€è¦§ã¸</button></div></div>`;

      wrap.appendChild(top); wrap.appendChild(qPanel); wrap.appendChild(histPanel); wrap.appendChild(donePanel); view.appendChild(wrap);

      function renderCard(){
        const c = due[idx];
        $('#qArea').textContent = c.qText || (c.qImg? 'ï¼ˆç”»åƒå•é¡Œï¼‰':'');
        $('#qImgArea').innerHTML = c.qImg? `<img src='${c.qImg}' style='max-width:260px;max-height:260px;object-fit:contain' />` : '';
        $('#aArea').textContent = c.aText || (c.aImg? 'ï¼ˆç”»åƒå›ç­”ï¼‰':'');
        $('#aImgArea').innerHTML = c.aImg? `<img src='${c.aImg}' style='max-width:260px;max-height:260px;object-fit:contain' />` : '';
        $('#answerBox').style.display='none';
        renderHistory(c);
      }
      function renderHistory(c){
        const el = $('#hist');
        if(!(c.attempts && c.attempts.length)) {
          el.innerHTML = `<div class='meta'>å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚åˆå›å‡ºé¡Œæ—¥ï¼š${fmt(nextDueDate(c))}</div>`;
          return;
        }
        const rows = c.attempts.map((a,i)=>`<div style='display:flex;justify-content:space-between'><div><span class='meta'>${i+1}å›ç›®</span> ${fmt(a.date)} ${a.time||''}</div><div><span class='meta'>${a.correct? 'æ­£è§£':'ä¸æ­£è§£'}</span></div></div>`).join('');
        const next = nextDueDate(c);
        el.innerHTML = rows + (next? `<div style='margin-top:8px' class='meta'>æ¬¡å›å‡ºé¡Œäºˆå®šæ—¥ï¼š${fmt(next)}</div>` : `<div style='margin-top:8px' class='meta'>7å›ç›®ã¾ã§å®Œäº†ã€‚ä»¥é™ã®å‡ºé¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`);
      }

      $('#revealBtn').onclick = ()=> { $('#answerBox').style.display='block'; };
      $('#correctBtn').onclick = ()=> grade(true);
      $('#wrongBtn').onclick = ()=> grade(false);

      function grade(correct){
        const c = due[idx];
        c.attempts.push({date: jstTodayISO(), time: jstTime(), correct});
        if(c.manualNextDue) delete c.manualNextDue;
        save();
        idx++;
        if(idx>=due.length){
          qPanel.style.display='none'; donePanel.style.display='block';
          $('#toHome').onclick = ()=> goHome();
        } else {
          $('#remain').textContent = (due.length - idx);
          renderCard();
        }
      }

      renderCard();
    }

    function renderProblems(view,{listId}){
      const list = DB.lists.find(x=>x.id===listId); if(!list){ goHome(); return; }
      setTitle(`å•é¡Œä¸€è¦§ï¼ˆ${list.name}ï¼‰`);
      view.innerHTML = '';
      const head = create('div'); head.className='panel';
      head.innerHTML = `<div style='display:flex;justify-content:space-between;align-items:center'><div><h3 style='margin:0'>ç™»éŒ²å•é¡Œ</h3><div class='meta'>åˆè¨ˆ ${listCards(listId).length} ä»¶</div></div><div><button id='addNew' class='btn btn-blue'>ï¼‹ æ–°è¦ç™»éŒ²</button></div></div>`;
      view.appendChild(head);
      $('#addNew').onclick = ()=> go('register',{listId});

      const items = listCards(listId).slice().sort((a,b)=> a.createdAt < b.createdAt ? -1 : 1);
      if(items.length === 0){ const e = create('div'); e.className='panel empty'; e.textContent='ã¾ã å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚'; view.appendChild(e); return; }

      const tableWrap = create('div'); tableWrap.className='panel';
      const table = create('table');
      const thead = create('thead'); thead.innerHTML = `<tr><th>ç™»éŒ²æ—¥</th><th>å•é¡Œ</th><th>å›ç­”</th><th>å‡ºé¡Œå±¥æ­´ï¼ˆæ—¥æ™‚/â—‹Ã—ï¼‰</th><th>æ¬¡å›äºˆå®š</th></tr>`; table.appendChild(thead);
      const tbody = create('tbody');

      items.forEach(c=>{
        const row = create('tr');
        const createdTd = create('td'); createdTd.textContent = fmt(c.createdAt);

        const qTd = create('td');
        if(c.qImg){ const img = create('img'); img.src = c.qImg; img.className='thumb'; img.onclick = ()=> showImage(c.qImg); qTd.appendChild(img); }
        const qText = create('div'); qText.textContent = c.qText || ''; qTd.appendChild(qText);

        const aTd = create('td');
        if(c.aImg){ const img2 = create('img'); img2.src = c.aImg; img2.className='thumb'; img2.onclick = ()=> showImage(c.aImg); aTd.appendChild(img2); }
        const aText = create('div'); aText.textContent = c.aText || ''; aTd.appendChild(aText);

        const histTd = create('td');
        histTd.innerHTML = (c.attempts && c.attempts.length)
          ? c.attempts.map((a,i)=>`<div>${i+1}å›ç›®ï¼š${fmt(a.date)} ${a.time||''} / ${a.correct? 'â—‹':'Ã—'}</div>`).join('')
          : 'â€”';

        const nextTd = create('td');
        const nextVal = nextDueDate(c);
        if(nextVal === null){
          nextTd.innerHTML = `<div class='meta'>å®Œäº†</div>`;
        }else{
          const dateInput = create('input'); dateInput.type='date'; dateInput.value = nextVal;
          dateInput.onchange = (e)=>{
            const v = e.target.value;
            if(!v){ delete c.manualNextDue; } else { c.manualNextDue = v; }
            save();
          };
          nextTd.appendChild(dateInput);

          const ctrl = create('div'); ctrl.style.marginTop='6px';
          const editBtn = create('button'); editBtn.className='btn btn-outline'; editBtn.textContent='âœï¸ ä¿®æ­£'; editBtn.onclick = ()=> go('edit',{listId,cardId:c.id});
          const delBtn = create('button'); delBtn.className='btn btn-danger'; delBtn.textContent='ğŸ—‘ å‰Šé™¤'; delBtn.onclick = ()=>{ if(confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ deleteCard(c.id); render(); } };
          ctrl.appendChild(editBtn); ctrl.appendChild(delBtn);
          nextTd.appendChild(ctrl);
        }

        row.appendChild(createdTd);
        row.appendChild(qTd);
        row.appendChild(aTd);
        row.appendChild(histTd);
        row.appendChild(nextTd);
        tbody.appendChild(row);
      });

      table.appendChild(tbody); tableWrap.appendChild(table); view.appendChild(tableWrap);
    }

    function renderEdit(view,{listId,cardId}){
      const list = DB.lists.find(x=>x.id===listId); const c = DB.cards.find(x=>x.id===cardId); if(!list || !c){ goHome(); return; }
      setTitle(`å•é¡Œä¿®æ­£ï¼ˆ${list.name}ï¼‰`);
      view.innerHTML = '';
      const form = create('form'); form.className='panel'; form.innerHTML = `
        <div style='display:flex;gap:12px;flex-wrap:wrap'>
          <div style='flex:1;min-width:220px'><label>å•é¡Œï¼ˆæ–‡ç« ï¼‰</label><textarea id='qText' rows='4'></textarea></div>
          <div style='width:260px'><label>å•é¡Œï¼ˆç”»åƒï¼‰</label><input type='file' id='qImg' accept='image/*' /><img id='qPreview' class='thumb' style='display:none;margin-top:8px' /></div>
        </div>
        <div style='display:flex;gap:12px;flex-wrap:wrap;margin-top:12px'>
          <div style='flex:1;min-width:220px'><label>å›ç­”ï¼ˆæ–‡ç« ï¼‰</label><textarea id='aText' rows='4'></textarea></div>
          <div style='width:260px'><label>å›ç­”ï¼ˆç”»åƒï¼‰</label><input type='file' id='aImg' accept='image/*' /><img id='aPreview' class='thumb' style='display:none;margin-top:8px' /></div>
        </div>
        <div style='margin-top:12px;display:flex;gap:8px;flex-wrap:wrap'><button class='btn btn-green'>ä¿å­˜</button><button type='button' id='cancelBtn' class='btn btn-outline'>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
      `;
      view.appendChild(form);
      $('#qText', form).value = c.qText || ''; $('#aText', form).value = c.aText || '';
      if(c.qImg){ $('#qPreview', form).src = c.qImg; $('#qPreview', form).style.display = 'block'; }
      if(c.aImg){ $('#aPreview', form).src = c.aImg; $('#aPreview', form).style.display = 'block'; }

      const qImg = $('#qImg', form); const aImg = $('#aImg', form);
      qImg.onchange = async ()=>{ const f=qImg.files[0]; if(!f) return; const url = await fileToDataURLCompressed(f); $('#qPreview', form).src = url; $('#qPreview', form).style.display='block'; }
      aImg.onchange = async ()=>{ const f=aImg.files[0]; if(!f) return; const url = await fileToDataURLCompressed(f); $('#aPreview', form).src = url; $('#aPreview', form).style.display='block'; }

      $('#cancelBtn', form).onclick = ()=> goHome();
      form.onsubmit = async (e)=>{
        e.preventDefault();
        const qText = $('#qText', form).value.trim();
        const aText = $('#aText', form).value.trim();
        let qImgData = c.qImg || ''; let aImgData = c.aImg || '';
        if(qImg.files[0]) qImgData = await fileToDataURLCompressed(qImg.files[0]);
        if(aImg.files[0]) aImgData = await fileToDataURLCompressed(aImg.files[0]);
        if(!qText && !qImgData){ alert('å•é¡Œã¯æ–‡ç« ã‹ç”»åƒã®ã„ãšã‚Œã‹ãŒå¿…è¦ã§ã™ã€‚'); return; }
        if(!aText && !aImgData){ alert('å›ç­”ã¯æ–‡ç« ã‹ç”»åƒã®ã„ãšã‚Œã‹ãŒå¿…è¦ã§ã™ã€‚'); return; }
        updateCard(c.id,{qText,aText,qImg:qImgData,aImg:aImgData});
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        go('problems',{listId});
      };
    }

    // ==== modal image ====
    const imgModal = $('#imgModal'); const imgModalImg = $('#imgModalImg');
    function showImage(src){ imgModalImg.src = src; imgModal.style.display = 'flex'; }
    imgModal.onclick = ()=> { imgModal.style.display = 'none'; imgModalImg.src=''; };

    function setTitle(t){ $('.title').textContent = t; }
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ==== ãƒªã‚¹ãƒˆæ¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ====
    async function exportListById(listId){
      const list = DB.lists.find(l=>l.id===listId);
      if(!list){ alert('ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      const cards = listCards(listId);

      async function blobRefToDataURL(ref){
        if(!ref) return '';
        const rec = await idbGet('blobs', ref);
        if(!rec || !rec.blob) return '';
        return await new Promise((res,rej)=>{
          const fr = new FileReader();
          fr.onload = ()=> res(fr.result);
          fr.onerror = rej;
          fr.readAsDataURL(rec.blob);
        });
      }

      const out = {
        type: 'flashcard-list',
        version: 1,
        list: { id:list.id, name:list.name, createdAt:list.createdAt },
        cards: await Promise.all(cards.map(async c=>({
          id: c.id,
          createdAt: c.createdAt,
          qText: c.qText || '',
          aText: c.aText || '',
          qImg: await blobRefToDataURL(c.qImgRef || null),
          aImg: await blobRefToDataURL(c.aImgRef || null),
          attempts: (c.attempts||[]).map(a=>({date:a.date,time:a.time,correct:!!a.correct})),
          manualNextDue: c.manualNextDue || null
        })))
      };

      const blob = new Blob([JSON.stringify(out)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const safe = list.name.replace(/[\\/:*?"<>|]/g,'_');
      a.download = `${safe}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ==== ãƒªã‚¹ãƒˆå˜ä½ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSON â†’ IndexedDBå¾©å…ƒï¼‰ ====
    function importFromJson(){
      const input = $('#importJsonInput');
      input.value = '';
      input.onchange = async (e)=>{
        try{
          const file = e.target.files?.[0];
          if(!file) return;
          const text = await file.text();
          const data = JSON.parse(text);

          // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¨åŒå½¢å¼ï¼‰
          if(!data || data.type!=='flashcard-list' || !data.list || !Array.isArray(data.cards)){
            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼‰');
            return;
          }

          // ãƒªã‚¹ãƒˆåã®é‡è¤‡å›é¿
          let name = String(data.list.name||'Imported').trim() || 'Imported';
          const names = new Set(DB.lists.map(l=>l.name));
          if(names.has(name)){
            let i=2;
            while(names.has(`${name} (${i})`)) i++;
            name = `${name} (${i})`;
          }

          // æ–°è¦ãƒªã‚¹ãƒˆä½œæˆ
          const newListId = createList(name);

          // ç”»åƒï¼ˆdataURLï¼‰â†’ Blob â†’ blobs ã‚¹ãƒˆã‚¢ã¸ä¿å­˜ã—å‚ç…§ã‚­ãƒ¼å–å¾—ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ URLç”Ÿæˆ
          async function dataUrlToRefAndUrl(dataUrl){
            if(!dataUrl) return {ref:null,url:''};
            const blob = dataURLtoBlob(dataUrl);
            const key = `img:${uuid()}`;
            await idbPut('blobs', {key, blob});
            const url = URL.createObjectURL(blob);
            return {ref:key, url};
          }

          // ã‚«ãƒ¼ãƒ‰å¾©å…ƒ
          for(const src of data.cards){
            const q = await dataUrlToRefAndUrl(src.qImg||'');
            const a = await dataUrlToRefAndUrl(src.aImg||'');
            const id = uuid();
            DB.cards.push({
              id,
              listId: newListId,
              createdAt: src.createdAt || jstTodayISO(),
              qText: src.qText || '',
              aText: src.aText || '',
              qImg: q.url,
              aImg: a.url,
              qImgRef: q.ref,
              aImgRef: a.ref,
              attempts: Array.isArray(src.attempts) ? src.attempts.map(v=>({date:v.date,time:v.time,correct:!!v.correct})) : [],
              manualNextDue: src.manualNextDue || null
            });
          }
          save();
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
          goHome();
        }catch(err){
          console.error(err);
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
      };
      input.click();
    }

    // ==== å®¹é‡ç¢ºèªï¼ˆãƒ•ã‚©ãƒ¼ãƒ ç›´ä¸‹ã«è¡¨ç¤ºï¼‰ ====
    async function updateCapacityLine(){
      const el = $('#capacityLine');
      try{
        if(navigator.storage?.estimate){
          const est = await navigator.storage.estimate();
          const used = est.usage ?? 0;
          const quota = est.quota ?? 0;
          const toMB = b => (b/(1024*1024)).toFixed(2);
          const free = quota - used;
          el.textContent = `å®¹é‡ï¼šä½¿ç”¨ ${toMB(used)} MB / ä¸Šé™ ${toMB(quota)} MBï¼ˆæ®‹ã‚Š ç´„ ${toMB(Math.max(0,free))} MBï¼‰`;
        }else{
          el.textContent = 'å®¹é‡ï¼šã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å–å¾—ã§ãã¾ã›ã‚“';
        }
      }catch{
        el.textContent = 'å®¹é‡ï¼šå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    }

    // ==== boot ====
    async function boot(){
      await openIDB();
      await loadFromIDBOrMigrate();
      if(stack.length === 0) stack.push({screen:'home', params:{}});
      render();
      // ãƒ‡ãƒãƒƒã‚°ç”¨
      window._DB = DB;
      window._exportListById = exportListById;
      window._importFromJson = importFromJson;
    }
    boot();

  })();
  </script>
</body>
</html>
